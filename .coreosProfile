# CoreOS .profile
# Currently, this file is sourced by monitor.sh. When run as part of a service things like '~' are not defined. Always use the full path.

# Aliases go first so they can be used by the functions
alias d='docker'
alias dps='docker ps -a'
alias dpsa='docker ps -a'
alias di='docker images'

alias f='fleetctl --strict-host-key-checking=false'
alias flm='fleetctl list-machines -l'
alias flu='fleetctl list-units'
alias fluf='fleetctl list-unit-files'
alias ftunnel='fleetctl --tunnel 10.10.10.10'

alias ssh='ssh -oStrictHostKeyChecking=no'

function fstartnetlocation() {
    numNetLocationInstances=1
    fstartService netlocation $numNetLocationInstances
}

function etctree() { 
    # TODO: get the key from adNimbusEnvironment, shouldn't be hardcoded
    for key in `etcdctl ls -recursive ${netLocationKey}`
    do
        echo -n $key=
        etcdctl get $key
    done
}

function checkAllNetlocationServices() {
    while true 
    do 
        echo '============================='; 
        for service in `fluf | grep 'launched.*launched' | grep netlocation | awk '{print $1}' `
        do 
            echo $service
            f journal -lines=5 $service
            echo
            echo
            read a
        done
    done
}

function curlNetLocation() {
    # Output the timestamp for comparison with other logs
    date

    nginxIpAddress=`fluf | grep nginx | sed 's/.*\///'`
    curl -X GET -H 'Symbi-Authentication: dummy' -H 'Content-Type: application/json' -H 'Accept: application/json' \
        "http://$nginxIpAddress:49160"
}

function fstartnginx() {
    fstartService nginx 1
}

function fstartconfd() {
    fstartService confd 1
}

function fstartmon() {
    fstartService monitor 1
}

function fstartService() {
    service=$1
    numServers=$2

    cd /home/core/share/$service

    echo Be patient, this can take awhile before you get the first service \"$service\" output for a total of $numServers 'service(s)'

    case $numServers in
    0)
	fleetctl start ${service}.service
	;;

    1)
	fleetctl start ${service}@1.service
	;;
    *)
        serviceRange='netlocation@{1..'$numServers'}.service'
        `eval fleetctl start $serviceRange`
	;;
    esac

    cd - > /dev/null

}

function fstartall() {
    drmf

    fstartnetlocation
    sleep 5
    fstartconfd
    sleep 5
    fstartnginx
    sleep 3
    fstartmon
    fluf
}

function fstatusall() {
    for service in `fluf -fields=unit | grep -v UNIT`; 
    do 
        echo $service 
        f status $service 
        read a 
        if test "$a" = "q"
        then
            return
        fi
        echo; 
        echo '==============' 
    done
}

function fdestroy() {
    if test "$1" = ""
    then
        svcs=$(fleetctl list-unit-files | awk '{print $1}')
    else
        svcs=$1
    fi

    for i in $svcs
    do
        fleetctl destroy $i
    done
    fleetctl list-unit-files
}

function drmf() {
    # Remove the raptor docker containers from each coreos. On clean shutdown or first time startup
    # there are no docker containers to remove
    for i in {101..105}
    do 
        dImages=`ssh -oStrictHostKeyChecking=no 172.17.8.$i docker ps -a 2>&1 | grep -v NAME | awk '{print $NF}'`
        if test ! "$dImages" == ""
        then
            echo Removing docker images $dImages
            ssh -oStrictHostKeyChecking=no 172.17.8.$i docker rm -f $dImages 
        fi
    done
}

cd /home/core/share 

# Make the fleetctl service variables available to shell scripts
set -a
. adNimbusEnvironment
set +a

ssh-add -L | grep insecure_private_key 2>&1 > /dev/null
if test ! $? == 0
then
    ssh-add insecure_private_key
fi

# Setup fleetctl status
if test "$SSH_AUTH_SOCK" == ""
then
    eval $(ssh-agent)
fi

export VIMINIT='set ic number tabstop=4 shiftwidth=4 expandtab noai nocin nosi inde=<CR> fileformat=unix'

# Custom bash prompt via kirsle.net/wizards/ps1.html
# Common to both .profiles
export PS1="\[$(tput setaf 5)\]\u@\[$(tput setaf 4)\]\h:\[$(tput setaf 2)\]\w:\n$\[$(tput setaf 0)\] \[$(tput sgr0)\]"
export CLICOLOR=1
export numInstances=`grep '^$num_instances' /home/core/share/config.rb | sed 's/.*=//'`


