{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CoreOS on EC2: http://coreos.com/docs/running-coreos/cloud-providers/ec2/",
  "Resources": {
    "CoreOSServerAutoScale": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "AvailabilityZones": {"Fn::GetAZs": ""},
        "LaunchConfigurationName": {"Ref": "CoreOSServerLaunchConfig"},
        "MinSize": "0",
        "MaxSize": "12",
        "DesiredCapacity": "0",
        "Tags": [
            {"Key": "Name", "Value": { "Ref" : "AWS::StackName" }, "PropagateAtLaunch": true}
        ]
      }
    },    
    "CoreOSServerLaunchConfig": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "ImageId" : "ami-REPLACEME",
        "InstanceType": "t2.micro",
        "KeyName": "AdNimbusUsWest2",
        "SecurityGroups": ["AdNimbusUsWest2-CoreOSSecurityGroup-Y3ZSINO39RK5"],
        "UserData" : { "Fn::Base64":
          { "Fn::Join": [ "", [
                "#cloud-config\n",
                "---\n",
                "coreos:\n",
                "  update:\n",
                "    reboot-strategy: 'off'\n",
                "  etcd:\n",
                "    discovery: https://discovery.etcd.io/REPLACEME\n",
                "    addr: $private_ipv4:4001\n",
                "    peer-addr: $private_ipv4:7001\n",
                "    peer-election-timeout: 2000\n",
                "    peer-heartbeat-interval: 500\n",
                "  fleet:\n",
                "    public-ip: $private_ipv4\n",
                "    etcd_request_timeout: 3.0\n",
                "  units:\n",
                "  - name: etcd.service\n",
                "    command: start\n",
                "  - name: fleet.service\n",
                "    command: start\n",
                "  - name: docker-tcp.socket\n",
                "    command: start\n",
                "    enable: true\n",
                "    content: |\n",
                "      [Unit]\n",
                "      Description=Docker Socket for the API\n\n",
                "      [Socket]\n",
                "      ListenStream=2375\n",
                "      Service=docker.service\n",
                "      BindIPv6Only=both\n\n",
                "      [Install]\n",
                "      WantedBy=sockets.target\n",
                "   # Note: sysctl.d is run before cloud-init\n",
                "   - name: runsysctl.service\n",
                "   command: start\n",
                "   content: |\n",
                "   [Unit]\n",
                "   Description=Run sysctl\n\n",
                "   [Service]\n",
                "   Type=oneshot\n",
                "   ExecStart=/bin/sh -c 'sysctl --system; sysctl -p /etc/sysctl.conf'\n",
                "   # Note: Can't set ulimit -Hn greater than 4096. Coreos doesnt have PAM\n",
                "   # module to support changes to /etc/security/limits.conf.\n",
                "   # Coreos expects docker container to have PAM. Centos has ulimit of 1048576.\n",
                "   # Note: write_files is executed before the coreos section, particularly the units\n",
                "# Note: write_files is executed before the coreos section\n",
                "write_files:\n",
                "  - path: /etc/sysctl.conf \n",
                "    owner: root:root \n",
                "    permissions: 644 \n",
                "    content: | \n",
                "      fs.file-max = 200000 \n",
                "  - path: /etc/sysctl.d/60-custom.conf \n",
                "    permissions: 644 \n",
                "    owner: root:root \n",
                "    content: | \n",
                "       # Allow reusing sockets in TIME_WAIT state for new connections \n",
                "       net.ipv4.tcp_tw_reuse = 1 \n\n",
                "       # Socket max connections waiting to get accepted; the listen() backlog. \n",
                "       # Default is 128. \n",
                "       net.core.somaxconn = 4096 \n\n",
                "       # Decrease fin timeout. After telling the client we are closing, how long to wait for a FIN, ACK? \n",
                "       # Default is 60. \n",
                "       net.ipv4.tcp_fin_timeout = 10 \n",
                "  - path: /etc/ntp.conf\n",
                "    permissions: 644\n",
                "    owner: root\n",
                "    content: |\n",
                "      # Allow for large adjustments in time\n",
                "      # From: http://serverfault.com/questions/365690/\n",
                "      #     best-practices-for-ntp-updating-in-virtualbox-virtual-machines-without-guest-add\n",
                "      tinker panic 0\n\n",
                "      # Common pool\n",
                "      server 0.coreos.pool.ntp.org\n",
                "      server 1.coreos.pool.ntp.org\n",
                "      server 2.coreos.pool.ntp.org\n",
                "      server 3.coreos.pool.ntp.org\n\n",
                "      # - Allow only time queries, at a limited rate.\n",
                "      # - Allow all local queries (IPv4, IPv6)\n",
                "      restrict default nomodify nopeer noquery limited kod\n",
                "      restrict 127.0.0.1\n",
                "      restrict [::1]\n",
                "  - path: /home/core/.bash_profile\n",
                "    permissions: 644\n",
                "    owner: core\n",
                "    content: |\n",
                "      #!/bin/bash\n\n",
                "      if test -f ~/ad-nimbus/.coreosProfile\n",
                "      then\n",
                "           . ~/ad-nimbus/.coreosProfile\n",
                "      fi\n"
            ] ]
          }
        }
      }
    }
  }
}
