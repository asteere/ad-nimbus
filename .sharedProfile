#! /bin/bash

# For foolish consistency use lowercase for function names

function cdad() {
    cd "$AD_NIMBUS_DIR"
}

function checknetlocation() {
    # Output the timestamp for comparison with other logs
    date

    if test -f "$AD_NIMBUS_DIR"/adNimbusEnvironment
    then
        . "$AD_NIMBUS_DIR"/adNimbusEnvironment
    fi

    # Use a known IP address. If we run curl on this box to nginx on this box we don't have an external IP address
    # TODO: Do we add the headers to the nodejs code or remove them here?
    #headers=-H 'Symbi-Authentication: dummy' -H 'Content-Type: application/json' -H 'Accept: application/json' 

    echo curl -X GET $headers "http://$nginxIpAddress:$nginxGuestOsPort?ipAddress=198.243.23.131"
    curl -X GET $headers "http://$nginxIpAddress:$nginxGuestOsPort?ipAddress=198.243.23.131"
}

function sourceadnimbusenvironment() {
    # Make the fleetctl service variables available to shell scripts
    set -a

    # TODO: does this break anything if we have these variables defined
    if test -f /etc/environment
    then
        . /etc/environment
    fi

    if test -f "$AD_NIMBUS_DIR"/adNimbusEnvironment
    then
        . "$AD_NIMBUS_DIR"/adNimbusEnvironment
    fi

    set +a
}

function updateadnimbusenvironment() {
    sed 's/REPLACE_ME/'$DOCKER_REGISTRY'/' "$AD_NIMBUS_DIR"/adNimbusEnvironment.tmpl > "$AD_NIMBUS_DIR"/adNimbusEnvironment; 

    sourceadnimbusenvironment
}

function createtar() {
    cd "$AD_NIMBUS_DIR"/..

    daProject=ad-nimbus
    gzFile=${daProject}_`date +%Y%m%d_%H%M%S`.tar.gz
    tar -zcvf $gzFile --exclude LoadTests/JMeter/jmeter*log --exclude consul/data --exclude '.vagrant' --exclude '.git' --exclude src --exclude=.vagrant.d --exclude nginx/.nginx.conf* $daProject

    ls -l $gzFile

    cd -
}

function removeNginxConfTempFiles() {
    echo Removing confd created '.nginx.conf*' temp files

    # TODO: Are these tmp files still getting created?
    if test -d "$AD_NIMBUS_DIR/nginx"
    then
        (cd "$AD_NIMBUS_DIR"/nginx; for i in {0..9}; do rm -f .nginx.conf${i}*; done)
    fi
}

function loadPrivateRegistry() {
    for i in nginx netlocation confd consul devutils
    do 
        d pull asteere/$i:$i
        d tag asteere/$i:$i localhost:5000/$i:$i; 
        d push localhost:5000/$i:$i; 
    done
}

function startPrivateRegistry() {
    docker run \
        -d \
        -p 5000:5000 \
        -v "$AD_NIMBUS_DIR"/registry:/registry \
        --name=adnimbus_registry \
        -e STORAGE_PATH=/registry \
        registry:2.0
}

sourceadnimbusenvironment

# Custom bash prompt via kirsle.net/wizards/ps1.html
export PS1="\[$(tput setaf 5)\]\u@\[$(tput setaf 4)\]\h:\[$(tput setaf 2)\]\w:\n$\[$(tput setaf 0)\] \[$(tput sgr0)\]"
export CLICOLOR=1

# Common less options
export LESS="-q -i-i -e -F -X -R"
